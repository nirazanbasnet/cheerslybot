# üöÄ Cloudflare Workers Deployment Guide for Cheersly Bot

## üéØ Why Cloudflare Workers?

### **100% FREE & HIGH PERFORMANCE**
- ‚úÖ **Free tier**: 100,000 requests/day
- ‚úÖ **Global edge deployment** (200+ locations worldwide)
- ‚úÖ **Ultra-fast performance** (sub-50ms response times)
- ‚úÖ **No credit card required**
- ‚úÖ **Built-in D1 database** (SQLite)
- ‚úÖ **Automatic SSL certificates**
- ‚úÖ **Zero cold starts**

## üìã Prerequisites

1. **GitHub Repository**: Push your code to GitHub
2. **Slack App**: Your Slack bot should be configured
3. **Environment Variables**: Have your Slack credentials ready

## üöÄ Step-by-Step Deployment

### 1. Prepare Your Code

```bash
# Install PostgreSQL dependency
npm install pg

# Commit all changes
git add .
git commit -m "Add database support and deployment config"
git push origin main
```

## üöÄ Deploy to Cloudflare Workers

### Step 1: Install Wrangler CLI

```bash
# Install Wrangler globally
npm install -g wrangler

# Or install locally
npm install wrangler --save-dev
```

### Step 2: Login to Cloudflare

```bash
# Login to your Cloudflare account
wrangler login
```

### Step 3: Create D1 Database

```bash
# Create a new D1 database
wrangler d1 create cheersly-db

# Note the database ID from the output
```

### Step 4: Update wrangler.toml

Update the `database_id` in `wrangler.toml` with your actual database ID:

```toml
[[d1_databases]]
binding = "DB"
database_name = "cheersly-db"
database_id = "your-actual-database-id-here"
```

### Step 5: Set Environment Variables

```bash
# Set your Slack credentials
wrangler secret put SLACK_BOT_TOKEN
wrangler secret put SLACK_SIGNING_SECRET
wrangler secret put SLACK_APP_ID

# Optional: Set channel IDs
wrangler secret put BIRTHDAY_CHANNEL_ID
wrangler secret put ANNIVERSARY_CHANNEL_ID
```

### Step 6: Deploy Your Worker

```bash
# Deploy to Cloudflare Workers
wrangler deploy
```

## üóÑÔ∏è Database Migration

### Step 1: Generate Migration Script

```bash
# Run the migration helper
node scripts/migrate-to-d1.js
```

This will generate the SQL schema and sample INSERT statements.

### Step 2: Create Database Tables

Run the generated SQL in your D1 database console:

```sql
-- Profiles table
CREATE TABLE IF NOT EXISTS profiles (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT UNIQUE,
    name TEXT NOT NULL,
    email TEXT UNIQUE NOT NULL,
    mobile TEXT,
    position TEXT,
    designation TEXT,
    join_date TEXT,
    address TEXT,
    blood_group TEXT,
    dob TEXT,
    image TEXT,
    secondary_contact TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Birthday config table
CREATE TABLE IF NOT EXISTS birthday_configs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    profile_id INTEGER REFERENCES profiles(id) ON DELETE CASCADE,
    message TEXT,
    image TEXT,
    last_celebrated_date DATE,
    added_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(profile_id)
);

-- Anniversary config table
CREATE TABLE IF NOT EXISTS anniversary_configs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    profile_id INTEGER REFERENCES profiles(id) ON DELETE CASCADE,
    message TEXT,
    image TEXT,
    last_celebrated_date DATE,
    added_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(profile_id)
);
```

### Step 3: Migrate Your Data

Use the INSERT statements generated by the migration script to populate your database with your team data.

## üîß Update Slack App Settings

1. **Go to [Slack API](https://api.slack.com/apps)**
2. **Select your app**
3. **Go to "Event Subscriptions"**
4. **Update Request URL to:** `https://your-worker.your-subdomain.workers.dev/slack/commands`
5. **Save changes**

## ‚öôÔ∏è Environment Variables

Set these using Wrangler CLI:

```bash
wrangler secret put SLACK_BOT_TOKEN
wrangler secret put SLACK_SIGNING_SECRET  
wrangler secret put SLACK_APP_ID
wrangler secret put BIRTHDAY_CHANNEL_ID
wrangler secret put ANNIVERSARY_CHANNEL_ID
```

## üéØ Benefits of Cloudflare Workers

- ‚úÖ **Ultra-fast Performance**: Sub-50ms response times globally
- ‚úÖ **Zero Cold Starts**: Always ready to respond
- ‚úÖ **Global Edge Network**: 200+ locations worldwide
- ‚úÖ **Built-in D1 Database**: SQLite with edge replication
- ‚úÖ **Automatic Scaling**: Handles traffic spikes automatically
- ‚úÖ **Free SSL**: Automatic HTTPS everywhere
- ‚úÖ **100% Free**: No hidden costs or limits

## üö® Troubleshooting

### Common Issues

1. **Worker Not Deploying**
   - Check `wrangler.toml` configuration
   - Verify database ID is correct
   - Ensure all secrets are set

2. **Slack Commands Not Working**
   - Verify Request URL in Slack app settings
   - Check environment variables are set
   - Ensure Worker is deployed and running

3. **Database Connection Failed**
   - Verify D1 database is created
   - Check database ID in wrangler.toml
   - Ensure tables are created

### Health Check

Visit: `https://your-worker.your-subdomain.workers.dev/health`

Should return:
```json
{
  "status": "healthy",
  "timestamp": "2025-01-29T10:30:00.000Z"
}
```

## üìä Monitoring

- **Cloudflare Dashboard**: Monitor Worker performance
- **D1 Database Console**: Track query performance
- **Slack App Analytics**: Monitor command usage

## üîÑ Updates

To update your bot:

1. **Make changes to your code**
2. **Run `wrangler deploy`**
3. **Test in Slack**

---

## üéâ You're All Set!

Your Cheersly bot is now:
- ‚úÖ **Hosted on Cloudflare Workers (100% FREE)**
- ‚úÖ **Using D1 database with edge replication**
- ‚úÖ **Deployed globally with ultra-fast performance**
- ‚úÖ **Scalable and reliable**

Happy celebrating! üéä
